<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goud Chain - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Minimalist design system */
        [x-cloak] { display: none !important; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
        }

        code, pre {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
        }

        button {
            transition: background-color 0.15s ease;
        }

        .fade-in {
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tooltip { position: relative; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            z-index: 50;
            background: #111;
            color: #888;
            border: 1px solid #1a1a1a;
            padding: 6px 10px;
            font-size: 11px;
            white-space: nowrap;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body class="bg-black text-white">
    <div x-data="dashboardApp()" x-init="init()" class="min-h-screen" x-cloak>
        <!-- Toast Notifications Container -->
        <div class="fixed top-4 right-4 z-50 space-y-2" style="max-width: 400px;">
            <template x-for="toast in toasts" :key="toast.id">
                <div @click="dismissToast(toast.id)"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-x-8"
                     x-transition:enter-end="opacity-100 translate-x-0"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="cursor-pointer rounded-lg border p-3 shadow-lg backdrop-blur-sm flex items-start gap-3"
                     :class="{
                         'bg-green-950/90 border-green-700': toast.type === 'success',
                         'bg-blue-950/90 border-blue-700': toast.type === 'info',
                         'bg-yellow-950/90 border-yellow-700': toast.type === 'warning',
                         'bg-red-950/90 border-red-700': toast.type === 'error'
                     }">
                    <div class="text-xs font-mono font-bold px-1.5 py-0.5 rounded"
                         :class="{
                             'bg-green-500/20 text-green-400': toast.type === 'success',
                             'bg-blue-500/20 text-blue-400': toast.type === 'info',
                             'bg-yellow-500/20 text-yellow-400': toast.type === 'warning',
                             'bg-red-500/20 text-red-400': toast.type === 'error'
                         }">
                        <span x-show="toast.type === 'success'">OK</span>
                        <span x-show="toast.type === 'info'">INFO</span>
                        <span x-show="toast.type === 'warning'">WARN</span>
                        <span x-show="toast.type === 'error'">ERR</span>
                    </div>
                    <div class="flex-1 text-sm text-white" x-text="toast.message"></div>
                </div>
            </template>
        </div>

        <!-- Header -->
        <header class="bg-black border-b border-zinc-800 sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-semibold text-white">Goud Chain</h1>
                        <p class="text-zinc-500 text-xs mt-1">Encrypted Blockchain</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- WebSocket Connection Status -->
                        <div class="flex items-center gap-2">
                            <span x-show="wsConnected" class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span x-show="!wsConnected" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                            <span class="text-xs text-zinc-400" x-text="wsConnected ? 'Live' : 'Polling'"></span>
                        </div>

                        <!-- Account Info -->
                        <span class="text-xs text-zinc-400" x-show="accountId">
                            <span x-text="accountId.substring(0, 12) + '...'"></span>
                        </span>

                        <!-- Refresh Button -->
                        <button @click="refresh()" class="bg-zinc-800 hover:bg-zinc-700 px-3 py-1.5 text-sm border border-zinc-700 transition">
                            <span x-show="!isRefreshing">Refresh</span>
                            <span x-show="isRefreshing">...</span>
                        </button>

                        <!-- Logout Button -->
                        <button @click="logout()" class="bg-zinc-800 hover:bg-zinc-700 px-3 py-1.5 text-sm border border-zinc-700 transition">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <section class="container mx-auto px-6 py-3">
            <div class="flex gap-1 border-b border-zinc-800 overflow-x-auto">
                <button @click="activeTab = 'dashboard'"
                        :class="activeTab === 'dashboard' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Dashboard
                </button>
                <button @click="activeTab = 'submit'"
                        :class="activeTab === 'submit' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Submit Data
                </button>
                <button @click="activeTab = 'collections'"
                        :class="activeTab === 'collections' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Collections
                    <span x-show="collections.length > 0" class="ml-1 bg-zinc-700 text-xs px-1.5 py-0.5" x-text="collections.length"></span>
                </button>
                <button @click="activeTab = 'blockchain'"
                        :class="activeTab === 'blockchain' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Explorer
                </button>
                <button @click="activeTab = 'network'"
                        :class="activeTab === 'network' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Network
                </button>
                <button @click="activeTab = 'analytics'"
                        :class="activeTab === 'analytics' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Analytics
                </button>
                <button @click="activeTab = 'audit'"
                        :class="activeTab === 'audit' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Audit Logs
                    <span x-show="auditLogs.length > 0" class="ml-1 bg-zinc-700 text-xs px-1.5 py-0.5" x-text="auditLogs.length"></span>
                </button>
                <button @click="activeTab = 'metrics'"
                        :class="activeTab === 'metrics' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Metrics
                </button>
                <button @click="activeTab = 'debug'"
                        :class="activeTab === 'debug' ? 'border-white text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'"
                        class="px-3 py-2 border-b-2 transition whitespace-nowrap text-sm">
                    Debug
                </button>
            </div>
        </section>

        <!-- Dashboard Tab (NEW) -->
        <section x-show="activeTab === 'dashboard'" class="container mx-auto px-6 py-8">
            <h2 class="text-3xl font-bold mb-6">Dashboard</h2>

            <!-- Key Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <!-- Chain Length -->
                <div class="bg-gradient-to-br from-blue-950/50 to-blue-900/30 rounded-lg p-6 border border-blue-800/50">
                    <div class="text-xs text-blue-300 mb-2">BLOCKCHAIN</div>
                    <div class="text-4xl font-bold text-blue-400 mb-1" x-text="blocks.length || 0"></div>
                    <div class="text-xs text-blue-300/60">Total Blocks</div>
                    <div class="text-xs text-zinc-500 mt-2" x-show="lastUpdated.blockchain">
                        Updated <span x-text="formatActivityTime(lastUpdated.blockchain)"></span>
                    </div>
                </div>

                <!-- Collections Count -->
                <div class="bg-gradient-to-br from-green-950/50 to-green-900/30 rounded-lg p-6 border border-green-800/50">
                    <div class="text-xs text-green-300 mb-2">COLLECTIONS</div>
                    <div class="text-4xl font-bold text-green-400 mb-1" x-text="collections.length || 0"></div>
                    <div class="text-xs text-green-300/60">Your Data</div>
                    <div class="text-xs text-zinc-500 mt-2" x-show="lastUpdated.collections">
                        Updated <span x-text="formatActivityTime(lastUpdated.collections)"></span>
                    </div>
                </div>

                <!-- Peer Count -->
                <div class="bg-gradient-to-br from-purple-950/50 to-purple-900/30 rounded-lg p-6 border border-purple-800/50">
                    <div class="text-xs text-purple-300 mb-2">NETWORK</div>
                    <div class="text-4xl font-bold text-purple-400 mb-1" x-text="networkInfo.peers?.length || 0"></div>
                    <div class="text-xs text-purple-300/60">Connected Peers</div>
                    <div class="text-xs text-zinc-500 mt-2" x-show="lastUpdated.network">
                        Updated <span x-text="formatActivityTime(lastUpdated.network)"></span>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="bg-gradient-to-br from-zinc-900/50 to-zinc-800/30 rounded-lg p-6 border border-zinc-700/50">
                    <div class="text-xs text-zinc-300 mb-2">CONNECTION</div>
                    <div class="text-4xl font-bold mb-1" :class="wsConnected ? 'text-green-400' : 'text-red-400'" x-text="wsConnected ? 'Live' : 'Polling'"></div>
                    <div class="text-xs text-zinc-400">WebSocket Status</div>
                    <div class="text-xs text-zinc-500 mt-2" x-show="wsConnected">
                        Real-time updates active
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="bg-zinc-950 rounded-lg border border-zinc-800 overflow-hidden mb-8">
                <div class="bg-zinc-900/50 px-6 py-4 border-b border-zinc-800 flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Recent Activity</h3>
                    <button @click="clearActivityFeed()"
                            x-show="activityFeed.length > 0"
                            class="text-xs text-zinc-400 hover:text-white transition">
                        Clear
                    </button>
                </div>

                <div class="divide-y divide-zinc-800" style="max-height: 400px; overflow-y: auto;">
                    <template x-for="activity in activityFeed.slice(0, 10)" :key="activity.id">
                        <div class="px-6 py-3 hover:bg-zinc-900/50 transition">
                            <div class="flex items-start gap-3">
                                <div class="text-xs font-mono font-bold px-2 py-1 rounded"
                                     :class="getActivityColor(activity.type)"
                                     x-text="getActivityIcon(activity.type)"></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-white" x-text="activity.message"></p>
                                    <p class="text-xs text-zinc-500 mt-1" x-text="formatActivityTime(activity.timestamp)"></p>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="activityFeed.length === 0" class="px-6 py-12 text-center text-zinc-500">
                        <p>No recent activity</p>
                        <p class="text-xs mt-1">Events will appear here as they happen</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button @click="activeTab = 'submit'" class="bg-white text-black rounded-lg p-4 hover:bg-zinc-200 transition text-left">
                    <div class="font-semibold mb-1">Submit Data</div>
                    <div class="text-sm text-zinc-700">Create encrypted collection</div>
                </button>

                <button @click="activeTab = 'collections'" class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:bg-zinc-800 transition text-left">
                    <div class="font-semibold mb-1">Browse Collections</div>
                    <div class="text-sm text-zinc-400">View and decrypt your data</div>
                </button>

                <button @click="activeTab = 'blockchain'" class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:bg-zinc-800 transition text-left">
                    <div class="font-semibold mb-1">Explore Blockchain</div>
                    <div class="text-sm text-zinc-400">View blocks and analytics</div>
                </button>
            </div>
        </section>

        <!-- Submit Data Tab -->
        <section x-show="activeTab === 'submit'" class="container mx-auto px-6 py-8">
            <div class="max-w-4xl mx-auto">
                <!-- Main Submit Form -->
                <div class="bg-zinc-950 p-6 border border-zinc-800">
                    <h2 class="text-xl font-semibold mb-4">Submit Encrypted Data</h2>

                    <p class="text-zinc-500 text-sm mb-6">
                        Data is encrypted with your API key before storage on the blockchain.
                    </p>

                    <div class="space-y-4">
                        <!-- Label -->
                        <div>
                            <label class="block text-xs font-medium mb-2 text-zinc-400">Label</label>
                            <input x-model="form.label" type="text" placeholder="e.g., API Keys"
                                   class="w-full bg-black border border-zinc-800 px-3 py-2 text-sm focus:outline-none focus:border-zinc-600">
                        </div>

                        <!-- Mode Toggle -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-zinc-500">Mode:</span>
                            <button @click="switchMode('form')"
                                    :class="inputMode === 'form' ? 'bg-zinc-700 border-zinc-600' : 'bg-black border-zinc-800 hover:border-zinc-700'"
                                    class="px-3 py-1.5 border transition text-xs">
                                Form
                            </button>
                            <button @click="switchMode('json')"
                                    :class="inputMode === 'json' ? 'bg-zinc-700 border-zinc-600' : 'bg-black border-zinc-800 hover:border-zinc-700'"
                                    class="px-3 py-1.5 border transition text-xs">
                                JSON
                            </button>
                        </div>

                        <!-- Form Builder Mode -->
                        <div x-show="inputMode === 'form'" class="space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="block text-sm font-medium">Data Fields</label>
                                <button @click="addField()" class="bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded text-sm transition">
                                    + Add Field
                                </button>
                            </div>

                            <div x-show="formFields.length === 0" class="bg-gray-700/50 rounded p-6 text-center text-gray-400 text-sm">
                                No fields yet. Click "Add Field" or use a template to get started.
                            </div>

                            <div class="space-y-2">
                                <template x-for="(field, index) in formFields" :key="index">
                                    <div class="bg-gray-700 rounded p-3 space-y-2">
                                        <div class="grid grid-cols-12 gap-2">
                                            <div class="col-span-4">
                                                <input x-model="field.key" type="text" placeholder="Key"
                                                       @input="updateJSONFromForm()"
                                                       class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            </div>
                                            <div class="col-span-2">
                                                <select x-model="field.type" @change="updateJSONFromForm()"
                                                        class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    <option value="string">Text</option>
                                                    <option value="number">Number</option>
                                                    <option value="boolean">Boolean</option>
                                                </select>
                                            </div>
                                            <div class="col-span-5">
                                                <input x-show="field.type !== 'boolean'" x-model="field.value"
                                                       :type="field.type === 'number' ? 'number' : 'text'"
                                                       placeholder="Value"
                                                       @input="updateJSONFromForm()"
                                                       class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <select x-show="field.type === 'boolean'" x-model="field.value" @change="updateJSONFromForm()"
                                                        class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    <option value="true">true</option>
                                                    <option value="false">false</option>
                                                </select>
                                            </div>
                                            <div class="col-span-1 flex items-center justify-center">
                                                <button @click="removeField(index)" class="text-red-400 hover:text-red-300 text-lg">
                                                    ×
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- JSON Preview -->
                            <div class="bg-gray-900 rounded p-4 border border-gray-600">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-xs text-gray-400">Preview:</p>
                                    <button @click="copyToClipboard(form.data)" class="text-xs text-blue-400 hover:text-blue-300">
                                        Copy
                                    </button>
                                </div>
                                <pre class="text-xs text-green-400 font-mono overflow-x-auto" x-text="form.data || '{}'"></pre>
                            </div>
                        </div>

                        <!-- Raw JSON Mode -->
                        <div x-show="inputMode === 'json'">
                            <label class="block text-sm font-medium mb-2">JSON Data *</label>
                            <textarea x-model="form.data"
                                      placeholder='{"key": "value", "another": 42}'
                                      class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 h-64 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      @input="validateJSON()"></textarea>
                            <div class="flex items-center justify-between mt-2">
                                <p class="text-xs text-gray-500">Enter any valid JSON object</p>
                                <span x-show="jsonValid" class="text-xs text-green-400">Valid JSON</span>
                                <span x-show="!jsonValid && form.data" class="text-xs text-red-400">Invalid JSON</span>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button @click="submitData()"
                                :disabled="!isFormValid() || isSubmitting"
                                :class="isFormValid() && !isSubmitting ? 'bg-white text-black hover:bg-zinc-200' : 'bg-zinc-800 text-zinc-500 cursor-not-allowed'"
                                class="w-full px-4 py-2 border border-zinc-800 transition text-sm font-medium">
                            <span x-show="!isSubmitting">Submit</span>
                            <span x-show="isSubmitting">Submitting...</span>
                        </button>
                    </div>

                    <!-- Result Message -->
                    <div x-show="submitResult" class="mt-4 p-3 border fade-in text-sm"
                         :class="submitResult?.success ? 'bg-zinc-950 border-zinc-700 text-zinc-300' : 'bg-zinc-950 border-red-900 text-red-400'">
                        <p x-html="submitResult?.message"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Collections Management -->
        <section x-show="activeTab === 'collections'" class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">My Encrypted Collections</h2>
                
                <!-- Collection Actions -->
                <div class="flex gap-2">
                    <button x-show="selectedCollections.length > 0"
                            @click="bulkDecryptCollections()"
                            class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm transition">
                        Decrypt Selected (<span x-text="selectedCollections.length"></span>)
                    </button>
                    <button x-show="selectedCollections.length > 0"
                            @click="exportSelected()"
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm transition">
                        Export Selected
                    </button>
                    <button @click="clearSelections()"
                            x-show="selectedCollections.length > 0"
                            class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-sm transition">
                        Clear
                    </button>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <input x-model="searchQuery" @input="filterCollections()" type="text"
                               placeholder="Search by label or ID..."
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <select x-model="sortBy" @change="sortCollections()"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="label">Label A-Z</option>
                            <option value="block">Block Number</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Total: <span class="text-blue-400 font-bold" x-text="filteredCollections.length"></span></span>
                    </div>
                </div>
            </div>

            <!-- Collections Grid -->
            <div x-show="filteredCollections.length === 0" class="bg-gray-800 rounded-lg p-12 text-center border border-gray-700">
                <p class="text-gray-400">
                    <span x-show="collections.length === 0">No collections yet. Submit some data to get started!</span>
                    <span x-show="collections.length > 0 && filteredCollections.length === 0">No collections match your search.</span>
                </p>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <template x-for="item in filteredCollections" :key="item.collection_id">
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition">
                        <div class="flex items-start gap-4">
                            <!-- Selection Checkbox -->
                            <div class="pt-1">
                                <input type="checkbox" 
                                       :checked="selectedCollections.includes(item.collection_id)"
                                       @change="toggleSelection(item.collection_id)"
                                       class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                            </div>
                            
                            <!-- Collection Info -->
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="text-lg font-bold text-blue-400" x-text="item.label"></h3>
                                        <p class="text-xs text-gray-400 mt-1 font-mono">
                                            ID: <span x-text="item.collection_id.substring(0, 16) + '...'"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Block #<span x-text="item.block_number"></span> • 
                                            <span x-text="new Date(item.created_at * 1000).toLocaleString()"></span>
                                        </p>
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div class="flex gap-2">
                                        <button @click="copyToClipboard(item.collection_id)"
                                                class="tooltip text-gray-400 hover:text-blue-400 text-sm">
                                            Copy ID
                                            <span class="tooltip-text">Copy ID</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Decrypt Section -->
                                <div x-show="!decryptedData[item.collection_id]">
                                    <button @click="decryptCollection(item.collection_id)"
                                            class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm transition">
                                        Decrypt Data
                                    </button>
                                </div>

                                <!-- Decrypted Data -->
                                <div x-show="decryptedData[item.collection_id]" class="bg-green-900/20 border border-green-700 rounded p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-green-400 text-sm font-bold">Decrypted Data:</p>
                                        <div class="flex gap-2">
                                            <button @click="copyToClipboard(decryptedData[item.collection_id])"
                                                    class="text-xs text-blue-400 hover:text-blue-300">
                                                Copy
                                            </button>
                                            <button @click="downloadJSON(item.label, decryptedData[item.collection_id])"
                                                    class="text-xs text-purple-400 hover:text-purple-300">
                                                Download
                                            </button>
                                        </div>
                                    </div>
                                    <pre class="bg-gray-900 rounded p-3 overflow-x-auto text-xs" x-text="JSON.stringify(JSON.parse(decryptedData[item.collection_id] || '{}'), null, 2)"></pre>
                                    <button @click="delete decryptedData[item.collection_id]"
                                            class="mt-2 bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-xs transition">
                                        Hide
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </section>

        <!-- Blockchain Explorer -->
        <section x-show="activeTab === 'blockchain'" class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Blockchain Explorer</h2>
                <div class="text-sm text-gray-400">
                    Total Blocks: <span class="text-blue-400 font-bold" x-text="blocks.length"></span>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <input x-model="blockSearch" @input="filterBlocks()" type="text"
                               placeholder="Search by index, hash, or validator..."
                               class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <select x-model="blockFilter" @change="filterBlocks()"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Blocks</option>
                            <option value="with_accounts">With Accounts</option>
                            <option value="with_collections">With Collections</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-end gap-2">
                        <span class="text-sm text-gray-400">Showing: <span class="text-blue-400 font-bold" x-text="filteredBlocks.length"></span></span>
                    </div>
                </div>
            </div>

            <!-- Blockchain Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-900/30 to-blue-800/20 rounded-lg p-4 border border-blue-700">
                    <div class="text-sm text-gray-400">Total Blocks</div>
                    <div class="text-2xl font-bold text-blue-400" x-text="blocks.length"></div>
                </div>
                <div class="bg-gradient-to-br from-green-900/30 to-green-800/20 rounded-lg p-4 border border-green-700">
                    <div class="text-sm text-gray-400">Total Collections</div>
                    <div class="text-2xl font-bold text-green-400" x-text="getTotalCollections()"></div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/30 to-purple-800/20 rounded-lg p-4 border border-purple-700">
                    <div class="text-sm text-gray-400">Total Accounts</div>
                    <div class="text-2xl font-bold text-purple-400" x-text="getTotalAccounts()"></div>
                </div>
                <div class="bg-gradient-to-br from-yellow-900/30 to-yellow-800/20 rounded-lg p-4 border border-yellow-700">
                    <div class="text-sm text-gray-400">Avg Block Time</div>
                    <div class="text-2xl font-bold text-yellow-400" x-text="getAvgBlockTime()"></div>
                </div>
            </div>

            <!-- Blocks List -->
            <div class="space-y-4">
                <template x-for="block in filteredBlocks" :key="block.index">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden hover:border-gray-600 transition">
                        <div class="bg-gray-700/50 px-6 py-4 flex items-center justify-between cursor-pointer"
                             @click="expandedBlock === block.index ? expandedBlock = null : expandedBlock = block.index">
                            <div class="flex-1">
                                <h3 class="font-bold text-blue-400 mb-1">Block #<span x-text="block.index"></span></h3>
                                <p class="text-xs text-gray-400">
                                    <span class="font-mono" x-text="block.validator"></span> • 
                                    <span x-text="(block.user_accounts?.length || 0)"></span> accounts • 
                                    <span x-text="(block.encrypted_collections?.length || 0)"></span> collections • 
                                    <span x-text="new Date(block.timestamp * 1000).toLocaleString()"></span>
                                </p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span x-show="block.index > 0" class="text-xs text-gray-500" x-text="getBlockTimeDiff(block.index)"></span>
                                <button class="text-gray-400">
                                    <span x-show="expandedBlock !== block.index">▼</span>
                                    <span x-show="expandedBlock === block.index">▲</span>
                                </button>
                            </div>
                        </div>

                        <div x-show="expandedBlock === block.index" class="px-6 py-4 space-y-4">
                            <!-- Block Details -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Hash:</span>
                                    <div class="flex items-center gap-2 mt-1">
                                        <code class="block text-xs text-blue-400 break-all flex-1" x-text="block.hash"></code>
                                        <button @click="copyToClipboard(block.hash)" class="text-gray-400 hover:text-blue-400 text-xs">Copy</button>
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-500">Previous Hash:</span>
                                    <div class="flex items-center gap-2 mt-1">
                                        <code class="block text-xs text-gray-400 break-all flex-1" x-text="block.previous_hash"></code>
                                        <button @click="copyToClipboard(block.previous_hash)" class="text-gray-400 hover:text-blue-400 text-xs">Copy</button>
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-500">Merkle Root:</span>
                                    <code class="block text-xs text-gray-400 mt-1 break-all" x-text="block.merkle_root || 'N/A'"></code>
                                </div>
                                <div>
                                    <span class="text-gray-500">Timestamp:</span>
                                    <code class="block text-xs text-gray-400 mt-1" x-text="block.timestamp"></code>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="flex gap-2 pt-2">
                                <button x-show="block.index > 0" 
                                        @click="navigateToBlock(block.index - 1)" 
                                        class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm transition">
                                    ← Previous Block
                                </button>
                                <button x-show="block.index < blocks.length - 1" 
                                        @click="navigateToBlock(block.index + 1)" 
                                        class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm transition">
                                    Next Block →
                                </button>
                            </div>

                            <!-- Block Content -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="text-sm font-bold mb-2">Accounts: <span x-text="block.user_accounts?.length || 0"></span></h4>
                                    <div class="text-xs text-gray-400" x-show="(block.user_accounts?.length || 0) === 0">No accounts</div>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold mb-2">Collections: <span x-text="block.encrypted_collections?.length || 0"></span></h4>
                                    <div class="text-xs text-gray-400" x-show="(block.encrypted_collections?.length || 0) === 0">No collections</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </section>

        <!-- Network Status Tab -->
        <section x-show="activeTab === 'network'" class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Network Status</h2>
                <button @click="syncWithPeers()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition">
                    Sync Now
                </button>
            </div>

            <!-- Node Health -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
                <h3 class="text-lg font-bold mb-4">Current Node Health</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-700 rounded p-4">
                        <div class="text-sm text-gray-400">Chain Length</div>
                        <div class="text-2xl font-bold text-green-400" x-text="blocks.length"></div>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <div class="text-sm text-gray-400">Peer Count</div>
                        <div class="text-2xl font-bold text-blue-400" x-text="networkInfo.peers?.length || 0"></div>
                    </div>
                    <div class="bg-gray-700 rounded p-4">
                        <div class="text-sm text-gray-400">Status</div>
                        <div class="text-2xl font-bold text-green-400">Healthy</div>
                    </div>
                </div>
            </div>

            <!-- Peer List -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-bold mb-4">Connected Peers</h3>
                <p class="text-xs text-gray-500 mb-4">Showing peers connected to the current node (load-balanced)</p>

                <div x-show="(networkInfo.peers?.length || 0) === 0" class="text-center py-8 text-gray-400">
                    No peers connected
                </div>

                <div class="space-y-2">
                    <template x-for="peer in networkInfo.peers" :key="peer">
                        <div class="bg-gray-700 rounded p-4 flex items-center justify-between">
                            <div>
                                <div class="font-mono text-sm text-blue-400" x-text="peer"></div>
                                <div class="text-xs text-gray-400 mt-1">
                                    Reputation: <span x-text="networkInfo.reputation?.[peer] || 100"></span>/100
                                </div>
                            </div>
                            <div class="text-green-400">Connected</div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Analytics Dashboard -->
        <section x-show="activeTab === 'analytics'" class="container mx-auto px-6 py-8">
            <h2 class="text-2xl font-bold mb-6">Analytics & Statistics</h2>

            <!-- Overview Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-900/30 to-blue-800/20 rounded-lg p-6 border border-blue-700">
                    <div class="text-sm text-gray-400 mb-1">Total Blocks</div>
                    <div class="text-3xl font-bold text-blue-400" x-text="blocks.length"></div>
                    <div class="text-xs text-gray-500 mt-2">Since genesis</div>
                </div>
                <div class="bg-gradient-to-br from-green-900/30 to-green-800/20 rounded-lg p-6 border border-green-700">
                    <div class="text-sm text-gray-400 mb-1">Total Collections</div>
                    <div class="text-3xl font-bold text-green-400" x-text="getTotalCollections()"></div>
                    <div class="text-xs text-gray-500 mt-2">Encrypted data entries</div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/30 to-purple-800/20 rounded-lg p-6 border border-purple-700">
                    <div class="text-sm text-gray-400 mb-1">Total Accounts</div>
                    <div class="text-3xl font-bold text-purple-400" x-text="getTotalAccounts()"></div>
                    <div class="text-xs text-gray-500 mt-2">Registered users</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-900/30 to-yellow-800/20 rounded-lg p-6 border border-yellow-700">
                    <div class="text-sm text-gray-400 mb-1">Avg Block Time</div>
                    <div class="text-3xl font-bold text-yellow-400" x-text="getAvgBlockTime()"></div>
                    <div class="text-xs text-gray-500 mt-2">Seconds per block</div>
                </div>
            </div>

            <!-- Charts Placeholder -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-bold mb-4">Block Creation Trend</h3>
                    <div class="h-64 flex items-center justify-center text-gray-500">
                        <canvas id="blockTrendChart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-bold mb-4">Data Growth</h3>
                    <div class="h-64 flex items-center justify-center text-gray-500">
                        <canvas id="dataGrowthChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Validator Distribution -->
            <div class="mt-6 bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-bold mb-4">Validator Distribution</h3>
                <div class="space-y-2">
                    <template x-for="(count, validator) in getValidatorDistribution()" :key="validator">
                        <div class="flex items-center gap-4">
                            <div class="w-32 text-sm text-gray-400 font-mono truncate" x-text="validator"></div>
                            <div class="flex-1 bg-gray-700 rounded-full h-6">
                                <div class="bg-blue-500 h-6 rounded-full flex items-center justify-end px-2 text-xs"
                                     :style="`width: ${(count / blocks.length) * 100}%`">
                                    <span class="text-white font-bold" x-text="count"></span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-400" x-text="((count / blocks.length) * 100).toFixed(1) + '%'"></div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Audit Logs Tab -->
        <section x-show="activeTab === 'audit'" class="container mx-auto px-6 py-8">
            <h2 class="text-2xl font-bold mb-6">Audit Logs</h2>
            <p class="text-zinc-500 text-sm mb-6">
                Complete audit trail of all operations performed with your API key. Logs are encrypted and stored on the blockchain (immutable).
            </p>

            <!-- Filters -->
            <div class="bg-zinc-950 p-4 border border-zinc-800 mb-6">
                <div class="flex flex-wrap gap-3 items-end">
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs text-zinc-400 mb-1">Event Type</label>
                        <select x-model="auditFilter.eventType" class="w-full bg-zinc-900 border border-zinc-700 px-3 py-2 text-sm focus:outline-none focus:border-white">
                            <option value="">All Events</option>
                            <option value="AccountCreated">Account Created</option>
                            <option value="AccountLogin">Account Login</option>
                            <option value="DataSubmitted">Data Submitted</option>
                            <option value="DataDecrypted">Data Decrypted</option>
                            <option value="DataListed">Data Listed</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs text-zinc-400 mb-1">Start Date</label>
                        <input type="date" x-model="auditFilter.startDate" class="w-full bg-zinc-900 border border-zinc-700 px-3 py-2 text-sm focus:outline-none focus:border-white">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs text-zinc-400 mb-1">End Date</label>
                        <input type="date" x-model="auditFilter.endDate" class="w-full bg-zinc-900 border border-zinc-700 px-3 py-2 text-sm focus:outline-none focus:border-white">
                    </div>
                    <button @click="fetchAuditLogs()" class="bg-white text-black px-6 py-2 text-sm hover:bg-zinc-200 transition">
                        Apply Filters
                    </button>
                    <button @click="exportAuditCSV()" class="bg-zinc-800 border border-zinc-700 px-6 py-2 text-sm hover:bg-zinc-700 transition">
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Audit Log Table -->
            <div class="bg-zinc-950 border border-zinc-800 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-zinc-900 border-b border-zinc-800">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-zinc-400">Timestamp</th>
                                <th class="px-4 py-3 text-left font-medium text-zinc-400">Event Type</th>
                                <th class="px-4 py-3 text-left font-medium text-zinc-400">IP Hash</th>
                                <th class="px-4 py-3 text-left font-medium text-zinc-400">Collection ID</th>
                                <th class="px-4 py-3 text-left font-medium text-zinc-400">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="log in auditLogs" :key="log.timestamp">
                                <tr class="border-b border-zinc-800 hover:bg-zinc-900 transition"
                                    :class="{'bg-zinc-900/50': log.confirmed === false}">
                                    <td class="px-4 py-3 text-zinc-300">
                                        <span x-text="formatTimestamp(log.timestamp)"></span>
                                        <span x-show="log.confirmed === false"
                                              class="ml-2 px-1.5 py-0.5 text-xs bg-yellow-900/30 border border-yellow-700/50 text-yellow-400"
                                              title="Pending blockchain confirmation">Pending</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 text-xs border border-zinc-700"
                                              :class="{
                                                  'bg-green-900/20 border-green-700 text-green-400': log.event_type === 'AccountCreated',
                                                  'bg-blue-900/20 border-blue-700 text-blue-400': log.event_type === 'AccountLogin',
                                                  'bg-purple-900/20 border-purple-700 text-purple-400': log.event_type === 'DataSubmitted',
                                                  'bg-yellow-900/20 border-yellow-700 text-yellow-400': log.event_type === 'DataDecrypted',
                                                  'bg-zinc-900/20 border-zinc-700 text-zinc-400': log.event_type === 'DataListed'
                                              }"
                                              x-text="log.event_type"></span>
                                    </td>
                                    <td class="px-4 py-3 font-mono text-zinc-400 text-xs" x-text="log.ip_hash"></td>
                                    <td class="px-4 py-3 font-mono text-zinc-400 text-xs">
                                        <span x-text="log.collection_id ? log.collection_id.substring(0, 12) + '...' : '-'"></span>
                                    </td>
                                    <td class="px-4 py-3 text-zinc-400" x-text="JSON.stringify(log.metadata)"></td>
                                </tr>
                            </template>
                            <template x-if="auditLogs.length === 0">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-zinc-500">
                                        <span x-show="!isLoadingAudit">No audit logs found</span>
                                        <span x-show="isLoadingAudit">Loading audit logs...</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center px-4 py-3 bg-zinc-900 border-t border-zinc-800">
                    <button @click="auditPage--; fetchAuditLogs()" :disabled="auditPage === 0"
                            class="bg-zinc-800 border border-zinc-700 px-4 py-1.5 text-sm disabled:opacity-30 disabled:cursor-not-allowed hover:bg-zinc-700 transition">
                        Previous
                    </button>
                    <span class="text-sm text-zinc-400">
                        Page <span x-text="auditPage + 1"></span> of <span x-text="auditTotalPages"></span>
                        (<span x-text="auditTotal"></span> total)
                    </span>
                    <button @click="auditPage++; fetchAuditLogs()" :disabled="auditPage >= auditTotalPages - 1"
                            class="bg-zinc-800 border border-zinc-700 px-4 py-1.5 text-sm disabled:opacity-30 disabled:cursor-not-allowed hover:bg-zinc-700 transition">
                        Next
                    </button>
                </div>
            </div>
        </section>

        <!-- System Metrics Tab -->
        <section x-show="activeTab === 'metrics'" class="container mx-auto px-6 py-8">
            <h2 class="text-2xl font-bold mb-6">System Metrics</h2>
            <p class="text-zinc-500 text-sm mb-6">
                Real-time performance metrics and operational statistics for the blockchain network.
            </p>

            <!-- Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Chain Length -->
                <div class="bg-zinc-950 p-6 border border-zinc-800">
                    <div class="text-zinc-400 text-xs mb-1">Chain Length</div>
                    <div class="text-3xl font-bold" x-text="metrics.chain_length || '-'"></div>
                    <div class="text-zinc-500 text-xs mt-1">Total Blocks</div>
                </div>

                <!-- Total Operations -->
                <div class="bg-zinc-950 p-6 border border-zinc-800">
                    <div class="text-zinc-400 text-xs mb-1">Total Operations</div>
                    <div class="text-3xl font-bold" x-text="metrics.total_operations || '-'"></div>
                    <div class="text-zinc-500 text-xs mt-1">All Time</div>
                </div>

                <!-- Cache Hit Rate -->
                <div class="bg-zinc-950 p-6 border border-zinc-800">
                    <div class="text-zinc-400 text-xs mb-1">Cache Hit Rate</div>
                    <div class="text-3xl font-bold">
                        <span x-text="metrics.cache_hit_rate ? (metrics.cache_hit_rate * 100).toFixed(1) + '%' : '-'"></span>
                    </div>
                    <div class="text-zinc-500 text-xs mt-1">Key Cache Performance</div>
                </div>

                <!-- Peer Count -->
                <div class="bg-zinc-950 p-6 border border-zinc-800">
                    <div class="text-zinc-400 text-xs mb-1">Connected Peers</div>
                    <div class="text-3xl font-bold" x-text="metrics.peer_count || '-'"></div>
                    <div class="text-zinc-500 text-xs mt-1">P2P Network</div>
                </div>
            </div>

            <!-- Operations Per Second Chart (Placeholder) -->
            <div class="bg-zinc-950 p-6 border border-zinc-800 mb-6">
                <h3 class="text-lg font-semibold mb-4">Operations Per Second</h3>
                <div class="text-center text-zinc-500 py-12">
                    <div class="text-6xl mb-4" x-text="metrics.operations_per_second ? metrics.operations_per_second.toFixed(2) : '0.00'"></div>
                    <div class="text-sm">ops/sec (last interval)</div>
                </div>
            </div>

            <!-- Additional Stats -->
            <div class="bg-zinc-950 p-6 border border-zinc-800">
                <h3 class="text-lg font-semibold mb-4">Detailed Statistics</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <div class="text-zinc-400 text-xs">Node ID</div>
                        <div class="font-mono mt-1" x-text="metrics.node_id || '-'"></div>
                    </div>
                    <div>
                        <div class="text-zinc-400 text-xs">Status</div>
                        <div class="mt-1">
                            <span class="px-2 py-1 bg-green-900/20 border border-green-700 text-green-400 text-xs">
                                Healthy
                            </span>
                        </div>
                    </div>
                    <div>
                        <div class="text-zinc-400 text-xs">Uptime</div>
                        <div class="font-mono mt-1">N/A</div>
                    </div>
                    <div>
                        <div class="text-zinc-400 text-xs">Last Block</div>
                        <div class="font-mono mt-1" x-text="metrics.latest_block_index || '-'"></div>
                    </div>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'debug'" class="container mx-auto px-6 py-8">
            <h2 class="text-2xl font-bold mb-6">Debug & Developer Tools</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- API Tester -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-bold mb-4">API Endpoint Tester</h3>
                    <div class="space-y-3">
                        <select x-model="debugEndpoint" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="/chain">GET /chain</option>
                            <option value="/peers">GET /peers</option>
                            <option value="/health">GET /health</option>
                            <option value="/data/list">GET /data/list</option>
                        </select>
                        <button @click="testEndpoint()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition">
                            Test Endpoint
                        </button>
                        <div x-show="debugResponse" class="bg-gray-900 rounded p-3 max-h-64 overflow-auto">
                            <pre class="text-xs text-green-400" x-text="debugResponse"></pre>
                        </div>
                    </div>
                </div>

                <!-- Export Tools -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-bold mb-4">Export Tools</h3>
                    <div class="space-y-3">
                        <button @click="exportBlockchain()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded transition">
                            Export Full Blockchain
                        </button>
                        <button @click="exportCollections()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded transition">
                            Export All Collections
                        </button>
                        <button @click="copySystemInfo()" class="w-full bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded transition">
                            Copy System Info
                        </button>
                    </div>
                </div>

                <!-- System Info -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-bold mb-4">System Information</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">API Base URL:</span>
                            <code class="text-blue-400 text-xs" x-text="API_BASE"></code>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Total Blocks:</span>
                            <code class="text-green-400 text-xs" x-text="blocks.length"></code>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Total Collections:</span>
                            <code class="text-blue-400 text-xs" x-text="getTotalCollections()"></code>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Detect API base URL dynamically
        // In development: http://localhost:8080
        // In production: same origin as dashboard (proxied through load balancer)
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : window.location.origin.replace(/dashboard/, 'api');

        function dashboardApp() {
            return {
                // State
                activeTab: 'dashboard',
                accountId: null,
                apiKey: null,
                inputMode: 'form',
                isRefreshing: false,
                isSubmitting: false,

                // Data
                collections: [],
                filteredCollections: [],
                blocks: [],
                filteredBlocks: [],
                decryptedData: {},
                networkInfo: { peers: [], reputation: {} },
                formFields: [],
                selectedCollections: [],

                // Audit Logs
                auditLogs: [],
                auditFilter: {
                    eventType: '',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: new Date().toISOString().split('T')[0]
                },
                auditPage: 0,
                auditTotal: 0,
                auditTotalPages: 0,
                isLoadingAudit: false,

                // Metrics
                metrics: {},

                // WebSocket - Real-time Updates
                ws: null,
                wsConnected: false,
                wsReconnectAttempts: 0,
                wsMaxReconnectDelay: 30000,

                // Toast Notifications
                toasts: [],
                nextToastId: 1,

                // Activity Feed
                activityFeed: [],
                maxActivityFeedItems: 50,

                // Audit Log Counter
                newAuditLogsCount: 0,

                // Last Updated Timestamps
                lastUpdated: {
                    collections: null,
                    blockchain: null,
                    network: null,
                    metrics: null
                },

                // Form
                form: { label: '', data: '' },
                submitResult: null,
                jsonValid: false,
                expandedBlock: null,

                // Search & Filter
                searchQuery: '',
                blockSearch: '',
                sortBy: 'newest',
                blockFilter: 'all',

                // Debug
                debugEndpoint: '/chain',
                debugResponse: '',

                // Initialize
                async init() {
                    this.apiKey = localStorage.getItem('goud_api_key');
                    this.accountId = localStorage.getItem('goud_account_id');

                    if (!this.apiKey) {
                        window.location.href = '/auth.html';
                        return;
                    }

                    // Check session expiry
                    const expiresAt = localStorage.getItem('goud_session_expires');
                    if (expiresAt && Date.now() > parseInt(expiresAt)) {
                        alert('Session expired. Please login again.');
                        this.logout();
                        return;
                    }

                    // Validate API key against backend (catches schema changes)
                    const isValid = await this.validateApiKey();
                    if (!isValid) {
                        alert('Your API key is no longer valid (blockchain schema may have changed). Please login again.');
                        this.logout();
                        return;
                    }

                    // Connect WebSocket for real-time updates
                    this.connectWebSocket();

                    // Initial data load
                    this.refresh();

                    // Fallback polling every 10 seconds (only when WebSocket disconnected)
                    setInterval(() => {
                        if (!this.wsConnected) {
                            // Fallback to polling when WebSocket is down
                            this.loadCollections();
                            this.loadChain();
                            this.loadNetworkInfo();
                        }
                        // Always poll audit logs and metrics (not real-time)
                        if (this.activeTab === 'audit') this.fetchAuditLogs();
                        if (this.activeTab === 'metrics') this.fetchMetrics();
                    }, 10000);
                },

                // Validate API key against backend
                async validateApiKey() {
                    try {
                        const res = await fetch(`${API_BASE}/data/list`, {
                            headers: { 'Authorization': `Bearer ${this.apiKey}` }
                        });

                        // 401 = invalid API key
                        // 200 = valid (even if empty collections list)
                        return res.ok;
                    } catch (e) {
                        console.error('Failed to validate API key:', e);
                        // On network error, assume valid to avoid unnecessary logouts
                        return true;
                    }
                },

                // ==================== WebSocket Real-Time Updates ====================

                connectWebSocket() {
                    try {
                        const wsUrl = API_BASE.replace('http', 'ws') + '/ws?token=' + encodeURIComponent(this.apiKey);
                        console.log('Connecting WebSocket:', wsUrl);
                        this.ws = new WebSocket(wsUrl);

                        this.ws.onopen = () => {
                            console.log('WebSocket connected');
                            this.wsConnected = true;
                            this.wsReconnectAttempts = 0;

                            // Subscribe to real-time events
                            this.wsSubscribe('blockchain_update');
                            this.wsSubscribe('collection_update');
                            this.wsSubscribe('peer_update');
                            this.wsSubscribe('audit_log_update');
                        };

                        this.ws.onmessage = (event) => {
                            try {
                                const msg = JSON.parse(event.data);
                                this.handleWebSocketMessage(msg);
                            } catch (e) {
                                console.error('Failed to parse WebSocket message:', e);
                            }
                        };

                        this.ws.onclose = (event) => {
                            console.log('WebSocket disconnected:', event.code, event.reason);
                            this.wsConnected = false;
                            this.reconnectWebSocket();
                        };

                        this.ws.onerror = (error) => {
                            console.error('WebSocket error:', error);
                            this.wsConnected = false;
                        };
                    } catch (e) {
                        console.error('Failed to create WebSocket:', e);
                        this.wsConnected = false;
                    }
                },

                reconnectWebSocket() {
                    const delay = Math.min(1000 * Math.pow(2, this.wsReconnectAttempts), this.wsMaxReconnectDelay);
                    this.wsReconnectAttempts++;
                    console.log(`WebSocket reconnecting in ${delay}ms (attempt ${this.wsReconnectAttempts})`);

                    setTimeout(() => {
                        if (!this.wsConnected) {
                            this.connectWebSocket();
                        }
                    }, delay);
                },

                wsSubscribe(eventType) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const msg = JSON.stringify({ type: 'subscribe', event: eventType });
                        this.ws.send(msg);
                        console.log('WebSocket subscribed:', eventType);
                    }
                },

                wsUnsubscribe(eventType) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const msg = JSON.stringify({ type: 'unsubscribe', event: eventType });
                        this.ws.send(msg);
                        console.log('WebSocket unsubscribed:', eventType);
                    }
                },

                handleWebSocketMessage(msg) {
                    console.log('WebSocket message:', msg);

                    switch (msg.type) {
                        case 'event':
                            // Handle different event types
                            if (msg.event === 'blockchain_update') {
                                const blockIndex = msg.block_index;
                                const blockHash = msg.block_hash?.substring(0, 8) || '';

                                // Toast notification
                                this.showToast(`New block #${blockIndex} added`, 'success', 3000);

                                // Activity feed
                                this.addActivity('block', `Block #${blockIndex} added`, {
                                    block_index: blockIndex,
                                    hash: blockHash
                                });

                                // Update last updated timestamp
                                this.lastUpdated.blockchain = Date.now();

                                // Refresh data
                                this.loadChain();

                            } else if (msg.event === 'collection_update') {
                                const collectionId = msg.collection_id?.substring(0, 12) || 'Unknown';

                                // Toast notification
                                this.showToast(`Collection created`, 'success', 3000);

                                // Activity feed
                                this.addActivity('collection', `New collection created`, {
                                    collection_id: msg.collection_id,
                                    block_index: msg.block_index
                                });

                                // Update last updated timestamp
                                this.lastUpdated.collections = Date.now();

                                // Refresh data
                                this.loadCollections();

                            } else if (msg.event === 'peer_update') {
                                const peerCount = msg.peer_count;

                                // Toast notification
                                this.showToast(`Network: ${peerCount} peer${peerCount !== 1 ? 's' : ''} connected`, 'info', 3000);

                                // Activity feed
                                this.addActivity('peer', `Network update: ${peerCount} peers`, {
                                    peer_count: peerCount
                                });

                                // Update last updated timestamp
                                this.lastUpdated.network = Date.now();

                                // Refresh data
                                this.loadNetworkInfo();

                            } else if (msg.event === 'audit_log_update') {
                                // Real-time audit log notification
                                this.newAuditLogsCount++;

                                // Activity feed with event type
                                const eventTypeName = msg.event_type || 'Unknown';
                                this.addActivity('audit', `${eventTypeName} event logged`, {
                                    event_type: eventTypeName,
                                    timestamp: msg.timestamp,
                                    confirmed: msg.confirmed || false
                                });

                                // Always update audit logs array (regardless of active tab)
                                // This ensures logs are visible when user switches to audit tab
                                const auditEntry = {
                                    event_type: eventTypeName,
                                    timestamp: msg.timestamp,
                                    collection_id: msg.collection_id || null,
                                    ip_hash: '(pending)', // Will be set when blockchain confirms
                                    metadata: msg.metadata || {},
                                    invalidated: false,
                                    confirmed: msg.confirmed || false
                                };

                                // Prepend to audit logs (newest first)
                                this.auditLogs.unshift(auditEntry);

                                // Limit to 50 entries to prevent memory issues
                                if (this.auditLogs.length > 50) {
                                    this.auditLogs = this.auditLogs.slice(0, 50);
                                }
                            } else if (msg.event === 'metrics_update') {
                                // Update metrics without toast (silent update)
                                this.metrics = msg.metrics || this.metrics;
                                this.lastUpdated.metrics = Date.now();

                                // Activity feed (only for significant changes)
                                if (msg.metrics?.chain_length) {
                                    // Don't spam feed, already handled by blockchain_update
                                }
                            }
                            break;

                        case 'subscribed':
                            console.log('Subscribed to:', msg.event);
                            break;

                        case 'unsubscribed':
                            console.log('Unsubscribed from:', msg.event);
                            break;

                        case 'pong':
                            // Keepalive response
                            break;

                        case 'error':
                            console.error('WebSocket error:', msg.message);
                            this.showToast(`Error: ${msg.message}`, 'error', 5000);
                            this.addActivity('error', `WebSocket error: ${msg.message}`);
                            break;

                        default:
                            console.warn('Unknown message type:', msg.type);
                    }
                },

                // ==================== Toast Notification System ====================

                showToast(message, type = 'info', duration = 4000) {
                    const toast = {
                        id: this.nextToastId++,
                        message,
                        type, // success, info, warning, error
                        timestamp: Date.now()
                    };

                    this.toasts.push(toast);

                    // Auto-dismiss after duration
                    setTimeout(() => {
                        this.dismissToast(toast.id);
                    }, duration);
                },

                dismissToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.toasts.splice(index, 1);
                    }
                },

                dismissAllToasts() {
                    this.toasts = [];
                },

                // ==================== Activity Feed ====================

                addActivity(type, message, metadata = {}) {
                    const activity = {
                        id: Date.now() + Math.random(),
                        type, // block, collection, peer, audit, metric
                        message,
                        metadata,
                        timestamp: Date.now()
                    };

                    this.activityFeed.unshift(activity); // Add to front

                    // Keep only last N items
                    if (this.activityFeed.length > this.maxActivityFeedItems) {
                        this.activityFeed = this.activityFeed.slice(0, this.maxActivityFeedItems);
                    }
                },

                clearActivityFeed() {
                    this.activityFeed = [];
                },

                getActivityIcon(type) {
                    const icons = {
                        block: 'BLK',
                        collection: 'COL',
                        peer: 'NET',
                        audit: 'SEC',
                        metric: 'MTR',
                        account: 'USR',
                        error: 'ERR'
                    };
                    return icons[type] || 'LOG';
                },

                getActivityColor(type) {
                    const colors = {
                        block: 'bg-blue-500/10 text-blue-400 border border-blue-500/20',
                        collection: 'bg-green-500/10 text-green-400 border border-green-500/20',
                        peer: 'bg-purple-500/10 text-purple-400 border border-purple-500/20',
                        audit: 'bg-yellow-500/10 text-yellow-400 border border-yellow-500/20',
                        metric: 'bg-zinc-700/50 text-zinc-400 border border-zinc-700',
                        account: 'bg-blue-500/10 text-blue-400 border border-blue-500/20',
                        error: 'bg-red-500/10 text-red-400 border border-red-500/20'
                    };
                    return colors[type] || 'bg-zinc-700/50 text-zinc-400 border border-zinc-700';
                },

                formatActivityTime(timestamp) {
                    const seconds = Math.floor((Date.now() - timestamp) / 1000);
                    if (seconds < 60) return `${seconds}s ago`;
                    const minutes = Math.floor(seconds / 60);
                    if (minutes < 60) return `${minutes}m ago`;
                    const hours = Math.floor(minutes / 60);
                    if (hours < 24) return `${hours}h ago`;
                    const days = Math.floor(hours / 24);
                    return `${days}d ago`;
                },

                // Generate request signature - Replay Attack Prevention
                // Format: X-Signature: ts={timestamp},nonce={nonce},sig={hex}
                // Signature = HMAC-SHA256(api_key, timestamp || nonce || SHA256(body))
                async signRequest(body) {
                    try {
                        // Generate timestamp (Unix seconds)
                        const timestamp = Math.floor(Date.now() / 1000);

                        // Generate cryptographically secure random nonce
                        const nonce = this.generateNonce();

                        // Decode base64 API key to raw bytes
                        const apiKeyBytes = this.base64ToBytes(this.apiKey);

                        // Compute SHA-256 hash of request body
                        const bodyHash = await this.sha256(body);

                        // Compute HMAC-SHA256 signature
                        const message = `${timestamp}${nonce}${bodyHash}`;
                        const signature = await this.hmacSha256(apiKeyBytes, message);

                        // Return formatted header value
                        return `ts=${timestamp},nonce=${nonce},sig=${signature}`;
                    } catch (e) {
                        console.error('Failed to sign request:', e);
                        throw new Error('Signature generation failed');
                    }
                },

                // Generate cryptographically secure random nonce (UUID v4)
                generateNonce() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                },

                // Decode base64 string to Uint8Array
                base64ToBytes(base64) {
                    const binaryString = atob(base64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return bytes;
                },

                // Compute SHA-256 hash and return hex string
                async sha256(message) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(message);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    return this.bufferToHex(hashBuffer);
                },

                // Compute HMAC-SHA256 and return hex string
                async hmacSha256(keyBytes, message) {
                    const encoder = new TextEncoder();
                    const messageBytes = encoder.encode(message);

                    // Import key for HMAC
                    const cryptoKey = await crypto.subtle.importKey(
                        'raw',
                        keyBytes,
                        { name: 'HMAC', hash: 'SHA-256' },
                        false,
                        ['sign']
                    );

                    // Sign message
                    const signatureBuffer = await crypto.subtle.sign('HMAC', cryptoKey, messageBytes);
                    return this.bufferToHex(signatureBuffer);
                },

                // Convert ArrayBuffer to hex string
                bufferToHex(buffer) {
                    return Array.from(new Uint8Array(buffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                },

                // ==================== Submit Data ====================

                addField() {
                    this.formFields.push({ key: '', value: '', type: 'string' });
                },

                removeField(index) {
                    this.formFields.splice(index, 1);
                    this.updateJSONFromForm();
                },

                updateJSONFromForm() {
                    const obj = {};
                    this.formFields.forEach(field => {
                        if (field.key) {
                            let value = field.value;
                            if (field.type === 'number') {
                                value = parseFloat(value) || 0;
                            } else if (field.type === 'boolean') {
                                value = value === 'true';
                            }
                            obj[field.key] = value;
                        }
                    });
                    this.form.data = JSON.stringify(obj, null, 2);
                    this.validateJSON();
                },

                switchMode(mode) {
                    if (mode === 'form' && this.inputMode === 'json') {
                        // Sync JSON to form
                        if (this.form.data) {
                            try {
                                const obj = JSON.parse(this.form.data);
                                this.formFields = Object.entries(obj).map(([key, value]) => {
                                    let type = 'string';
                                    if (typeof value === 'number') type = 'number';
                                    else if (typeof value === 'boolean') type = 'boolean';
                                    return {
                                        key: key,
                                        value: type === 'boolean' ? value.toString() : value,
                                        type: type
                                    };
                                });
                            } catch (e) {
                                this.formFields = [];
                            }
                        }
                    }
                    this.inputMode = mode;
                },

                validateJSON() {
                    try {
                        if (this.form.data.trim()) {
                            JSON.parse(this.form.data);
                            this.jsonValid = true;
                        } else {
                            this.jsonValid = false;
                        }
                    } catch (e) {
                        this.jsonValid = false;
                    }
                },

                isFormValid() {
                    if (!this.form.label) return false;
                    if (this.inputMode === 'form') {
                        return this.formFields.some(f => f.key.trim() !== '');
                    } else {
                        return this.jsonValid;
                    }
                },

                async submitData() {
                    if (!this.isFormValid()) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    // Ensure JSON is up to date
                    if (this.inputMode === 'form') {
                        this.updateJSONFromForm();
                    }

                    this.isSubmitting = true;
                    const startTime = performance.now();

                    try {
                        // Prepare request body
                        const body = JSON.stringify(this.form);

                        // Generate request signature - Replay Attack Prevention
                        const signature = await this.signRequest(body);
                        console.log('Generated signature:', signature);

                        const headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`,
                            'X-Signature': signature
                        };
                        console.log('Request headers:', headers);

                        const res = await fetch(`${API_BASE}/data/submit`, {
                            method: 'POST',
                            headers: headers,
                            body: body
                        });

                        const endTime = performance.now();
                        const duration = (endTime - startTime).toFixed(0);

                        const data = await res.json();
                        if (data.error) {
                            this.submitResult = { success: false, message: `ERROR: ${data.error}<br>⏱️ Request time: ${duration}ms` };
                        } else {
                            let perfClass = 'text-green-400';
                            let perfLabel = 'Excellent';
                            if (duration > 2000) {
                                perfClass = 'text-red-400';
                                perfLabel = 'Slow';
                            } else if (duration > 1000) {
                                perfClass = 'text-yellow-400';
                                perfLabel = 'Good';
                            }

                            this.submitResult = {
                                success: true,
                                message: `✅ Data encrypted and stored on blockchain!<br>
                                    📦 Collection ID: <code class="text-blue-400">${data.collection_id.substring(0, 16)}...</code><br>
                                    🔗 Block: <code class="text-purple-400">#${data.block_number}</code><br>
                                    ⏱️ <span class="${perfClass} font-bold">Block creation time: ${duration}ms</span> <span class="text-zinc-500">(${perfLabel})</span>`
                            };

                            this.form = { label: '', data: '' };
                            this.formFields = [];
                            this.jsonValid = false;

                            setTimeout(() => {
                                this.loadCollections();
                                this.loadChain();
                            }, 1000);
                        }
                    } catch (e) {
                        const endTime = performance.now();
                        const duration = (endTime - startTime).toFixed(0);
                        this.submitResult = { success: false, message: `ERROR: ${e.message}<br>⏱️ Request time: ${duration}ms` };
                    } finally {
                        this.isSubmitting = false;
                    }
                },

                // ==================== Collections Management ====================

                async loadCollections() {
                    try {
                        const res = await fetch(`${API_BASE}/data/list`, {
                            headers: { 'Authorization': `Bearer ${this.apiKey}` }
                        });
                        const data = await res.json();
                        if (!data.error) {
                            this.collections = data.collections;
                            this.lastUpdated.collections = Date.now();
                            this.filterCollections();
                        }
                    } catch (e) {
                        console.error('Failed to load collections:', e);
                    }
                },

                filterCollections() {
                    let filtered = [...this.collections];

                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(c =>
                            c.label.toLowerCase().includes(query) ||
                            c.collection_id.toLowerCase().includes(query)
                        );
                    }

                    switch (this.sortBy) {
                        case 'newest':
                            filtered.sort((a, b) => b.created_at - a.created_at);
                            break;
                        case 'oldest':
                            filtered.sort((a, b) => a.created_at - b.created_at);
                            break;
                        case 'label':
                            filtered.sort((a, b) => a.label.localeCompare(b.label));
                            break;
                        case 'block':
                            filtered.sort((a, b) => b.block_number - a.block_number);
                            break;
                    }

                    this.filteredCollections = filtered;
                },

                sortCollections() {
                    this.filterCollections();
                },

                toggleSelection(collectionId) {
                    const index = this.selectedCollections.indexOf(collectionId);
                    if (index > -1) {
                        this.selectedCollections.splice(index, 1);
                    } else {
                        this.selectedCollections.push(collectionId);
                    }
                },

                clearSelections() {
                    this.selectedCollections = [];
                },

                async bulkDecryptCollections() {
                    for (const id of this.selectedCollections) {
                        await this.decryptCollection(id);
                    }
                },

                exportSelected() {
                    const selected = this.filteredCollections.filter(c => 
                        this.selectedCollections.includes(c.collection_id)
                    );
                    const exportData = selected.map(c => ({
                        label: c.label,
                        collection_id: c.collection_id,
                        block_number: c.block_number,
                        created_at: c.created_at,
                        decrypted_data: this.decryptedData[c.collection_id] ? JSON.parse(this.decryptedData[c.collection_id]) : null
                    }));
                    this.downloadJSON('goud-collections-export', JSON.stringify(exportData, null, 2));
                },

                async decryptCollection(collectionId) {
                    try {
                        const res = await fetch(`${API_BASE}/data/decrypt/${collectionId}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.apiKey}` }
                        });

                        const data = await res.json();
                        if (data.error) {
                            alert(`ERROR: ${data.error}`);
                        } else {
                            this.decryptedData[collectionId] = data.data;
                        }
                    } catch (e) {
                        alert(`ERROR: ${e.message}`);
                    }
                },

                // ==================== Blockchain Explorer ====================

                async loadChain() {
                    try {
                        const res = await fetch(`${API_BASE}/chain`);
                        const data = await res.json();
                        this.blocks = data.chain.reverse();
                        this.lastUpdated.blockchain = Date.now();
                        this.filterBlocks();
                        this.renderCharts();
                    } catch (e) {
                        console.error('Failed to load blockchain:', e);
                    }
                },

                filterBlocks() {
                    let filtered = [...this.blocks];

                    // Search filter
                    if (this.blockSearch) {
                        const query = this.blockSearch.toLowerCase();
                        filtered = filtered.filter(b =>
                            b.index.toString().includes(query) ||
                            b.hash.toLowerCase().includes(query) ||
                            b.validator.toLowerCase().includes(query)
                        );
                    }

                    // Type filter
                    switch (this.blockFilter) {
                        case 'with_accounts':
                            filtered = filtered.filter(b => (b.user_accounts?.length || 0) > 0);
                            break;
                        case 'with_collections':
                            filtered = filtered.filter(b => (b.encrypted_collections?.length || 0) > 0);
                            break;
                    }

                    this.filteredBlocks = filtered;
                },

                navigateToBlock(index) {
                    this.expandedBlock = index;
                    // Scroll to block
                    setTimeout(() => {
                        document.querySelector(`[x-text="block.index"]`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                },

                getTotalCollections() {
                    return this.blocks.reduce((sum, block) => 
                        sum + (block.encrypted_collections?.length || 0), 0
                    );
                },

                getTotalAccounts() {
                    return this.blocks.reduce((sum, block) => 
                        sum + (block.user_accounts?.length || 0), 0
                    );
                },

                getAvgBlockTime() {
                    if (this.blocks.length < 2) return 'N/A';
                    // Blocks array is reversed (newest first), so we need to calculate in reverse
                    let totalTime = 0;
                    for (let i = this.blocks.length - 1; i > 0; i--) {
                        totalTime += this.blocks[i - 1].timestamp - this.blocks[i].timestamp;
                    }
                    const avgTime = totalTime / (this.blocks.length - 1);
                    return (avgTime.toFixed(2) + 's');
                },

                getBlockTimeDiff(index) {
                    if (index === 0) return 'Genesis';
                    const current = this.blocks.find(b => b.index === index);
                    const previous = this.blocks.find(b => b.index === index - 1);
                    if (!current || !previous) return 'N/A';
                    const diff = current.timestamp - previous.timestamp;
                    return `+${diff.toFixed(2)}s`;
                },

                getValidatorDistribution() {
                    const dist = {};
                    this.blocks.forEach(block => {
                        dist[block.validator] = (dist[block.validator] || 0) + 1;
                    });
                    return dist;
                },

                // ==================== Network Status ====================

                async loadNetworkInfo() {
                    try {
                        const res = await fetch(`${API_BASE}/peers`);
                        const data = await res.json();
                        this.networkInfo = data;
                        this.lastUpdated.network = Date.now();
                    } catch (e) {
                        console.error('Failed to load network info:', e);
                    }
                },

                async syncWithPeers() {
                    try {
                        await fetch(`${API_BASE}/sync`);
                        alert('Sync initiated with peers');
                        this.loadChain();
                    } catch (e) {
                        alert(`ERROR: Sync failed - ${e.message}`);
                    }
                },

                // ==================== Analytics ====================

                renderCharts() {
                    // Destroy existing charts before creating new ones
                    if (window.blockTrendChartInstance) {
                        window.blockTrendChartInstance.destroy();
                    }
                    if (window.dataGrowthChartInstance) {
                        window.dataGrowthChartInstance.destroy();
                    }

                    // Block trend chart - show cumulative block count over time
                    const blockCtx = document.getElementById('blockTrendChart');
                    if (blockCtx && this.blocks.length > 0) {
                        // Get last 10 blocks in ascending order (oldest to newest)
                        const recentBlocks = this.blocks.slice(-10).reverse();
                        const labels = recentBlocks.map(b => `#${b.index}`);
                        const data = recentBlocks.map((b, idx) => idx + Math.max(0, this.blocks.length - 10) + 1);

                        window.blockTrendChartInstance = new Chart(blockCtx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Total Blocks',
                                    data: data,
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: '#374151' } },
                                    x: { grid: { color: '#374151' } }
                                }
                            }
                        });
                    }

                    // Data growth chart
                    const dataCtx = document.getElementById('dataGrowthChart');
                    if (dataCtx && this.blocks.length > 0) {
                        const labels = this.blocks.slice(-10).map(b => `#${b.index}`);
                        let cumulative = 0;
                        const data = this.blocks.slice(-10).map(b => {
                            cumulative += (b.encrypted_collections?.length || 0);
                            return cumulative;
                        });

                        window.dataGrowthChartInstance = new Chart(dataCtx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Total Collections',
                                    data: data,
                                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                    borderColor: 'rgb(34, 197, 94)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: '#374151' } },
                                    x: { grid: { color: '#374151' } }
                                }
                            }
                        });
                    }
                },

                // ==================== Debug Tools ====================

                async testEndpoint() {
                    try {
                        const headers = {};
                        if (this.debugEndpoint === '/data/list') {
                            headers['Authorization'] = `Bearer ${this.apiKey}`;
                        }
                        const res = await fetch(`${API_BASE}${this.debugEndpoint}`, { headers });
                        const data = await res.json();
                        this.debugResponse = JSON.stringify(data, null, 2);
                    } catch (e) {
                        this.debugResponse = `Error: ${e.message}`;
                    }
                },

                exportBlockchain() {
                    this.downloadJSON('goud-blockchain-export', JSON.stringify(this.blocks, null, 2));
                },

                exportCollections() {
                    this.downloadJSON('goud-collections-export', JSON.stringify(this.collections, null, 2));
                },

                copySystemInfo() {
                    const info = `
Goud Chain Dashboard v2.0.0
API Base: ${API_BASE}
Account ID: ${this.accountId}
Total Blocks: ${this.blocks.length}
Total Collections: ${this.getTotalCollections()}
Total Accounts: ${this.getTotalAccounts()}
Peers: ${this.networkInfo.peers?.length || 0}
                    `.trim();
                    this.copyToClipboard(info);
                },

                // ==================== Audit Logging & Metrics ====================

                async fetchAuditLogs() {
                    this.isLoadingAudit = true;
                    try {
                        // Build query params
                        const params = new URLSearchParams({
                            page: this.auditPage.toString(),
                            page_size: '50'
                        });

                        if (this.auditFilter.eventType) {
                            params.append('event_type', this.auditFilter.eventType);
                        }
                        if (this.auditFilter.startDate) {
                            const startTs = new Date(this.auditFilter.startDate).getTime();
                            params.append('start_ts', startTs.toString());
                        }
                        if (this.auditFilter.endDate) {
                            // Add end of day (23:59:59.999) to include all events on the selected date
                            const endTs = new Date(this.auditFilter.endDate).getTime() + (24 * 60 * 60 * 1000 - 1);
                            params.append('end_ts', endTs.toString());
                        }

                        const res = await fetch(`${API_BASE}/api/audit?${params}`, {
                            headers: {
                                'Authorization': `Bearer ${this.sessionToken || this.apiKey}`
                            }
                        });

                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${await res.text()}`);
                        }

                        const data = await res.json();
                        this.auditLogs = data.logs || [];
                        this.auditTotal = data.total || 0;
                        this.auditTotalPages = data.total_pages || 0;
                    } catch (e) {
                        console.error('Failed to fetch audit logs:', e);
                        alert(`Failed to load audit logs: ${e.message}`);
                    } finally {
                        this.isLoadingAudit = false;
                    }
                },

                exportAuditCSV() {
                    if (this.auditLogs.length === 0) {
                        alert('No audit logs to export');
                        return;
                    }

                    const csv = [
                        ['Timestamp', 'Event Type', 'IP Hash', 'Collection ID', 'Metadata'],
                        ...this.auditLogs.map(log => [
                            new Date(log.timestamp).toISOString(),
                            log.event_type,
                            log.ip_hash,
                            log.collection_id || '',
                            JSON.stringify(log.metadata)
                        ])
                    ].map(row => row.join(',')).join('\n');

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audit_logs_${Date.now()}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                async fetchMetrics() {
                    try {
                        const res = await fetch(`${API_BASE}/api/metrics`, {
                            headers: {
                                'Authorization': `Bearer ${this.sessionToken || this.apiKey}`
                            }
                        });

                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}`);
                        }

                        const data = await res.json();
                        this.metrics = data;
                    } catch (e) {
                        console.error('Failed to fetch metrics:', e);
                        // Use fallback data from /health or /chain
                        this.metrics = {
                            chain_length: this.blocks.length,
                            total_operations: this.getTotalCollections() + this.getTotalAccounts(),
                            peer_count: this.networkInfo.peers?.length || 0,
                            cache_hit_rate: 0,
                            operations_per_second: 0,
                            node_id: 'unknown'
                        };
                    }
                },

                formatTimestamp(ts) {
                    const date = new Date(ts);
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },

                // ==================== Utilities ====================

                async refresh() {
                    this.isRefreshing = true;
                    const promises = [
                        this.loadCollections(),
                        this.loadChain(),
                        this.loadNetworkInfo()
                    ];

                    // Load audit logs if on audit tab
                    if (this.activeTab === 'audit') {
                        promises.push(this.fetchAuditLogs());
                    }

                    // Load metrics if on metrics tab
                    if (this.activeTab === 'metrics') {
                        promises.push(this.fetchMetrics());
                    }

                    await Promise.all(promises);
                    this.isRefreshing = false;
                },

                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        // Could show a toast notification here
                    });
                },

                downloadJSON(filename, content) {
                    const blob = new Blob([content], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filename}-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                logout() {
                    localStorage.removeItem('goud_session');
                    localStorage.removeItem('goud_api_key');
                    localStorage.removeItem('goud_account_id');
                    localStorage.removeItem('goud_session_expires');
                    window.location.href = '/auth.html';
                }
            }
        }
    </script>
</body>
</html>
