<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goud Chain - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body class="bg-black text-white">
    <div x-data="authApp()" x-init="checkExistingSession()" class="min-h-screen flex items-center justify-center px-6">
        <div class="max-w-md w-full">
            <!-- Logo/Header -->
            <div class="text-center mb-8">
                <h1 class="text-2xl font-semibold mb-2">Goud Chain</h1>
                <p class="text-zinc-500 text-sm">Encrypted Blockchain</p>
            </div>

            <!-- Tab Selector -->
            <div class="bg-zinc-950 flex border-b border-zinc-800">
                <button @click="activeTab = 'login'"
                        :class="activeTab === 'login' ? 'bg-zinc-900 text-white border-b-2 border-white' : 'text-zinc-500'"
                        class="flex-1 py-3 px-6 text-sm transition">
                    Login
                </button>
                <button @click="activeTab = 'signup'"
                        :class="activeTab === 'signup' ? 'bg-zinc-900 text-white border-b-2 border-white' : 'text-zinc-500'"
                        class="flex-1 py-3 px-6 text-sm transition">
                    Create Account
                </button>
            </div>

            <!-- Login Tab -->
            <div x-show="activeTab === 'login'" class="bg-zinc-950 p-6 border-x border-b border-zinc-800">
                <form @submit.prevent="login()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium mb-2 text-zinc-400">API Key</label>
                            <input x-model="loginForm.apiKey"
                                   type="password"
                                   placeholder="Paste your API key"
                                   required
                                   class="w-full bg-black border border-zinc-800 px-3 py-2 focus:outline-none focus:border-zinc-600 font-mono text-sm">
                            <p class="text-xs text-zinc-600 mt-1">Enter your API key</p>
                        </div>

                        <button type="submit"
                                :disabled="!loginForm.apiKey"
                                :class="loginForm.apiKey ? 'bg-white text-black hover:bg-zinc-200' : 'bg-zinc-800 text-zinc-500 cursor-not-allowed'"
                                class="w-full py-2 border border-zinc-800 text-sm font-medium transition">
                            Login
                        </button>

                        <div x-show="loginError"
                             class="bg-zinc-950 border border-red-900 p-3 text-sm text-red-400"
                             x-text="loginError">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Signup Tab -->
            <div x-show="activeTab === 'signup'" class="bg-zinc-950 p-6 border-x border-b border-zinc-800">
                <div x-show="!newAccount">
                    <form @submit.prevent="createAccount()">
                        <div class="space-y-4">
                            <div class="bg-zinc-900 border border-zinc-800 p-4 text-sm">
                                <p class="font-medium text-zinc-300 mb-2 text-xs">About API Keys</p>
                                <ul class="text-zinc-500 space-y-1 text-xs">
                                    <li>• Your API key is your authentication credential</li>
                                    <li>• It will only be shown once - save it securely</li>
                                    <li>• Anyone with your API key can access your data</li>
                                    <li>• Lost keys cannot be recovered</li>
                                </ul>
                            </div>

                            <button type="submit"
                                    class="w-full bg-white text-black hover:bg-zinc-200 py-2 border border-zinc-800 text-sm font-medium transition">
                                Generate API Key
                            </button>

                            <div x-show="signupError"
                                 class="bg-zinc-950 border border-red-900 p-3 text-sm text-red-400"
                                 x-text="signupError">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- API Key Display (After Creation) -->
                <div x-show="newAccount" class="space-y-4">
                    <div class="bg-zinc-900 border border-zinc-800 p-4">
                        <p class="text-white font-medium mb-2 text-sm">Save Your API Key</p>
                        <p class="text-xs text-zinc-500 mb-3" x-text="newAccount?.warning"></p>

                        <div class="bg-black border border-zinc-800 p-3 mb-3">
                            <p class="text-xs text-zinc-600 mb-2">API Key</p>
                            <div class="flex items-center gap-2">
                                <input :value="newAccount?.api_key"
                                       readonly
                                       class="flex-1 bg-zinc-950 border border-zinc-800 px-2 py-1.5 font-mono text-xs text-zinc-300 focus:outline-none">
                                <button @click="copyApiKey()"
                                        class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 px-3 py-1.5 text-xs transition whitespace-nowrap">
                                    <span x-show="!copied">Copy</span>
                                    <span x-show="copied">Copied</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-zinc-900 border border-zinc-800 p-2 text-xs text-zinc-400">
                            <p><strong class="text-zinc-300">Account ID:</strong> <span x-text="newAccount?.account_id"></span></p>
                        </div>
                    </div>

                    <!-- Mandatory Confirmation Checkbox -->
                    <div class="bg-zinc-900 border border-zinc-800 p-3">
                        <label class="flex items-start gap-2 cursor-pointer">
                            <input type="checkbox"
                                   x-model="apiKeyConfirmed"
                                   class="mt-0.5 w-4 h-4 bg-zinc-800 border-zinc-700">
                            <span class="text-xs text-zinc-400">
                                I have saved my API key. I understand that I <strong class="text-zinc-200">cannot recover my data without it</strong>.
                            </span>
                        </label>
                    </div>

                    <button @click="loginWithNewKey()"
                            :disabled="!apiKeyConfirmed"
                            :class="apiKeyConfirmed ? 'bg-white text-black hover:bg-zinc-200' : 'bg-zinc-800 text-zinc-600 cursor-not-allowed'"
                            class="w-full py-2 border border-zinc-800 text-sm font-medium transition">
                        Continue to Dashboard
                    </button>

                    <p class="text-center text-xs text-zinc-600" x-show="!apiKeyConfirmed">
                        Confirm you've saved your API key
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Detect API base URL dynamically
        // In development: http://localhost:8080
        // In production: same origin as dashboard (proxied through load balancer)
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : window.location.origin.replace(/dashboard/, 'api');

        function authApp() {
            return {
                activeTab: 'login',
                loginForm: {
                    apiKey: ''
                },
                loginError: '',
                signupError: '',
                newAccount: null,
                copied: false,
                apiKeyConfirmed: false,

                checkExistingSession() {
                    const session = localStorage.getItem('goud_session');
                    const apiKey = localStorage.getItem('goud_api_key');

                    if (session && apiKey) {
                        // Already logged in, redirect to dashboard
                        window.location.href = '/';
                    }
                },

                async login() {
                    this.loginError = '';

                    try {
                        const response = await fetch(`${API_BASE}/account/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ api_key: this.loginForm.apiKey })
                        });

                        const data = await response.json();

                        if (data.error) {
                            this.loginError = data.error;
                            return;
                        }

                        // Store session token and API key
                        localStorage.setItem('goud_session', data.session_token);
                        localStorage.setItem('goud_api_key', this.loginForm.apiKey);
                        localStorage.setItem('goud_account_id', data.account_id);
                        localStorage.setItem('goud_session_expires', Date.now() + (data.expires_in * 1000));

                        // Redirect to dashboard
                        window.location.href = '/';
                    } catch (error) {
                        this.loginError = `Error: ${error.message}`;
                    }
                },

                async createAccount() {
                    this.signupError = '';

                    try {
                        const response = await fetch(`${API_BASE}/account/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ metadata: null })
                        });

                        const data = await response.json();

                        if (data.error) {
                            this.signupError = data.error;
                            return;
                        }

                        this.newAccount = data;
                    } catch (error) {
                        this.signupError = `Error: ${error.message}`;
                    }
                },

                async loginWithNewKey() {
                    if (!this.newAccount) return;

                    this.loginForm.apiKey = this.newAccount.api_key;
                    await this.login();
                },

                copyApiKey() {
                    if (!this.newAccount) return;

                    navigator.clipboard.writeText(this.newAccount.api_key);
                    this.copied = true;

                    setTimeout(() => {
                        this.copied = false;
                    }, 2000);
                }
            }
        }
    </script>
</body>
</html>
