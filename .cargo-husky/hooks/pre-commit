#!/bin/sh

# Rust checks
echo "Running Rust formatting..."
cargo fmt

# Re-add any formatted files that were staged
STAGED_RS_FILES=$(git diff --name-only --cached | grep '\.rs$' || true)
if [ -n "$STAGED_RS_FILES" ]; then
    echo "$STAGED_RS_FILES" | xargs git add
fi

echo "Running Clippy..."
cargo clippy -- -D warnings || {
    echo "Error: Clippy found issues."
    exit 1
}

echo "Running Rust tests (including circular dependency checks)..."
cargo test || {
    echo "Error: Tests failed."
    exit 1
}

echo "Building Rust project..."
cargo build || {
    echo "Error: Build failed."
    exit 1
}

echo "Generating module dependency graph..."
./scripts/generate_module_graph.sh || {
    echo "Warning: Failed to generate module graph (non-fatal)"
}

# Stage the module graph if it changed
if [ -f "docs/module-structure.png" ]; then
    git add docs/module-structure.png docs/module-structure.dot
fi

# Dashboard checks
echo "Running dashboard tests..."
./dashboard/test.sh || {
    echo "Error: Dashboard tests failed."
    exit 1
}

# Terraform checks
if [ -d "terraform" ]; then
    echo "Running Terraform format check..."
    terraform -chdir=terraform fmt -check -recursive || {
        echo "Formatting Terraform files..."
        terraform -chdir=terraform fmt -recursive
        # Re-add formatted terraform files
        STAGED_TF_FILES=$(git diff --name-only --cached | grep '\.tf$' || true)
        if [ -n "$STAGED_TF_FILES" ]; then
            echo "$STAGED_TF_FILES" | xargs git add
        fi
    }

    echo "Running Terraform validation..."
    if [ -d "terraform/environments/free-tier" ]; then
        terraform -chdir=terraform/environments/free-tier init -backend=false -upgrade=false > /dev/null 2>&1 || true
        terraform -chdir=terraform/environments/free-tier validate || {
            echo "Error: Terraform validation failed."
            exit 1
        }
    fi
fi

echo "All pre-commit checks passed!"
